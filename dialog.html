<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/styles.css">
  <style>
    body { padding: 20px; font-family: Arial, sans-serif; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    input[type="text"] { width: 100%; box-sizing: border-box; }
    .button-bar { margin-top: 20px; display: flex; justify-content: space-between; }
    #status-container { margin-top: 20px; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; min-height: 50px; }
    #timer { float: right; color: #666; font-size: 0.9em; }
    .running { color: #0072c6; }
    .done { color: #107c10; }
    .error { color: #d83b01; font-weight: bold; }
    .idle { color: #555; }
  </style>
</head>
<body>
  <h3>フォルダ同期設定</h3>
  <p>コピー元と同期先のフォルダID（またはURL）を入力してください。<br>同期先に存在しないファイルやフォルダがコピーされます。</p>

  <div class="form-group">
    <label for="sourceFolder">1. コピー元フォルダ</label>
    <input type="text" id="sourceFolder" placeholder="例: 1a2b3c...">
  </div>

  <div class="form-group">
    <label for="destFolder">2. 同期先フォルダ</label>
    <input type="text" id="destFolder" placeholder="例: 4x5y6z...">
  </div>

  <div class="button-bar">
    <div>
      <button id="startButton" class="action" onclick="startSync()">同期を開始</button>
      <button id="stopButton" onclick="stopSync()">強制停止</button>
    </div>
    <button onclick="google.script.host.close()">閉じる</button>
  </div>

  <div id="status-container">
    <div id="timer">経過時間: 0秒</div>
    <h4>現在のステータス</h4>
    <div id="status" class="idle">待機中</div>
  </div>

  <script>
    let poller;
    let timerInterval;

    document.addEventListener('DOMContentLoaded', () => {
      // 初期状態をまず取得して、実行中だった場合のフォルダIDを復元する
      google.script.run
        .withSuccessHandler(initialState => {
          updateStatus(initialState);
          // 初期化が完了してからポーリングを開始する
          pollStatus();
          poller = setInterval(pollStatus, 2000);
        })
        .withFailureHandler(handleFailure)
        .getSyncStatus();
    });

    function startSync() {
      const sourceFolder = document.getElementById('sourceFolder').value;
      const destFolder = document.getElementById('destFolder').value;
      if (!sourceFolder || !destFolder) {
        updateStatus({ status: 'ERROR', message: 'コピー元と同期先の両方を入力してください。' });
        return;
      }
      setControlsState(true);
      updateStatus({ status: 'RUNNING', message: '同期ジョブを開始しています...' });
      const folderIds = { sourceFolder, destFolder };
      google.script.run
        .withSuccessHandler(() => pollStatus())
        .withFailureHandler(handleFailure)
        .startSyncJob(folderIds);
    }

    function stopSync() {
      setControlsState(true);
      updateStatus({ status: 'IDLE', message: 'ジョブを停止しています...' });
      google.script.run
        .withSuccessHandler(() => {
          pollStatus();
          stopTimer();
        })
        .withFailureHandler(handleFailure)
        .stopSyncJob();
    }

    function pollStatus() {
      google.script.run
        .withSuccessHandler(updateStatus)
        .withFailureHandler(handleFailure)
        .getUIStatus();
    }

    function updateStatus(state) {
      const statusDiv = document.getElementById('status');
      if (!state || !state.status) { // Check for a valid status
        statusDiv.className = 'error';
        statusDiv.textContent = 'ステータスを取得できませんでした。';
        setControlsState(false);
        stopTimer();
        return;
      }

      // getSyncStatusから呼ばれた場合（初回ロード時）のみIDを更新
      if (state.sourceFolderId) document.getElementById('sourceFolder').value = state.sourceFolderId;
      if (state.destFolderId) document.getElementById('destFolder').value = state.destFolderId;

      let message = state.message || state.status || '待機中...';
      const processed = state.processed || 0;
      const total = state.total || 0;

      if (total > 0) {
        message += ` (${processed}/${total})`;
      }
      statusDiv.textContent = message;


      switch(state.status) {
        case 'RUNNING':
          statusDiv.className = 'running';
          setControlsState(true);
          startTimer(state.startTime);
          break;
        case 'DONE':
          statusDiv.className = 'done';
          setControlsState(false);
          stopTimer(state.startTime);
          if (poller) {
            clearInterval(poller);
            poller = null;
            setTimeout(pollStatus, 1000);
            setTimeout(pollStatus, 3000);
          }
          break;
        case 'ERROR':
          statusDiv.className = 'error';
          setControlsState(false);
          stopTimer();
          if (poller) {
            clearInterval(poller);
            poller = null;
            setTimeout(pollStatus, 1000);
          }
          break;
        case 'IDLE':
        default:
          statusDiv.className = 'idle';
          setControlsState(false);
          stopTimer();
          break;
      }
    }

    function handleFailure(error) {
      updateStatus({ status: 'ERROR', message: error.message });
      clearInterval(poller);
      stopTimer();
    }

    function setControlsState(syncing) {
      document.getElementById('startButton').disabled = syncing;
      document.getElementById('sourceFolder').disabled = syncing;
      document.getElementById('destFolder').disabled = syncing;
    }

    function startTimer(startTime) {
      if (timerInterval || !startTime) return;
      const timerDiv = document.getElementById('timer');
      timerInterval = setInterval(() => {
        const elapsedSeconds = Math.round((Date.now() - startTime) / 1000);
        const minutes = Math.floor(elapsedSeconds / 60);
        const seconds = elapsedSeconds % 60;
        timerDiv.textContent = `経過時間: ${minutes}分 ${seconds}秒`;
      }, 1000);
    }

    function stopTimer(startTime) {
      clearInterval(timerInterval);
      timerInterval = null;
      const timerDiv = document.getElementById('timer');
      if (startTime) {
          const elapsedSeconds = Math.round((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsedSeconds / 60);
          const seconds = elapsedSeconds % 60;
          timerDiv.textContent = `経過時間: ${minutes}分 ${seconds}秒`;
      } else {
          timerDiv.textContent = "経過時間: 0秒";
      }
    }
  </script>
</body>
</html>
